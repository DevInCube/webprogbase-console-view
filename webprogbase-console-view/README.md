# Модуль **ClientView** (`webprogbase/client_view`)

## Мета

* Зрозуміти принципи комунікації інтерфейса користувача і основної частини програми через запити і відповіді (_HTTP Request\Response_)
* Обробка спрощеної вхідної інформації запиту від клієнта:
  * В який стан перейти (_Resource URI_)
  * Які вхідні дані опрацювати (_HTTP POST Request Body_)
* Передача спрощеної інформації клієнту через відповідь:
  * Який контент показати у поточному стані (_HTML_)
  * Які можливі переходи з поточного стану може вибрати клієнт (_HRef_)
  * В який стан автоматично перенаправити клієнта (_Redirect_)
  * Які дані клієнт має запитати у користувача (_HTML Form_) і в який стан клієнт має надіслати ці дані серверу після завершення вводу (_HTML Form Action_)

## Використання модуля

Даний модуль дозволяє створювати програми із консольним інтерфейсом використовуючи заданий API.

Інтерфейс проектується за допомогою графу станів зі станами двох видів:

* Простий стан для відображення тексту та можливими переходами у інші стани на вибір користувача.
* Стан із формою для вводу користувачем даних із автоматичним переходом у інший заданий стан та передачею йому введених даних.

Розроблювана програма має реалізувати доступ до початкового стану з іменем `/`, до якого буде автоматично виконано запит клієнтом при старті.  
Назви всіх інших станів довільні (окрім `/`, `<`, `>`).

## Відображення та взаємодія із інтерфейсом користувача

1. Всі стани, по яких відбуваються переходи заносяться у історію станів. Для навігації по історії станів можна використовувати ключі спеціальних переходів, які автоматично підставляються у список переходів станів, якщо вони доступні:

    * Перехід у початковий стан (`/`)
    * Перехід до попереднього стану (`<`)
    * Перехід до наступного стану (`>`)

1. При вводі даних у форму можна:

    * Повернутися до вводу попереднього поля (`<`). На першому полі це призведе до переходу до попереднього стану
    * Відмінити ввід у форму і повернутись до попереднього стану (`<<`)

## ConsoleView

### Створення екземпляру консольного інтерфейсу

Потрібно підключити модуль та створити об'єкт:

```js
let {ConsoleView} = require('./webprogbase/console_view');

let view = new ConsoleView();
```

### `use(stateName, stateHandler)`

Задати для стану (`stateName`) функцію-обробник (`stateHandler`).  
Обробник (`stateHandler(request, response)`) може приймати два параметри:

* `request` - об'єкт типу `Request`
* `response` - об'єкт типу `Response`

### `listen()`

Запустити роботу модуля після налаштування.  
Модуль на початку роботи виконує запит на зміну стану у початковий (`/`)

## Request

Містить вхідну інформацію від клієнта для виконання переходу:

* `state` - (строка) назва стану, у який виконується перехід
* `data` - (об'єкт) словник вхідних даних (якщо є)

## Response

Дозволяє відповісти клієнту одним із трьох способів:

1. `response.redirect(stateName)`
1. `response.send(stateText, statesDict)`
1. `response.send(stateText, stateForm)`

### `redirect(stateName)`

Використовується для перенаправлення клієнта у інший стан (Redirect).

### `send(stateText, statesDict)`

Використовується для передачі клієнту тексту для відображення та списку можлививих переходів у інші стани:

* `stateText` - (строка) текст, який потрібно відобразити у поточному стані
* `statesDict` - (об'єкт) словник переходів, що визначає, до яких станів клієнт може перейти із поточного стану. Ключі словника - назви станів, значення словника - строки з описом цих станів.

Приклад:

```js
let states = {
    "create": "New student",
    "showAll": "Show all students"
};
res.send("You are in main menu", states);
```

### `send(stateText, stateForm)`

Використовується для передачі клієнту тексту для відображення та форми вводу даних:

* `stateText` - (строка) текст, який відобразити у поточному стані перед вводом форми
* `stateForm` - (об'єкт) об'єкт  типу `InputForm`, що описує форму вводу даних. Приймає у паарметрах конструктора назву стану, якому надіслати введені дані та об'єкт з описом полів форми, де ключ - назва поля, а значення - короткий опис поля для виводу користувачу перед вводом.

Приклад:

```js
let nextState = "formProcessStateName";
let fields = {
    "name": "Enter student name",
    "score": "Enter score (int)",
};
let form = new InputForm(nextState, fields);
res.send("Some form text", form);
```

## Помилки використання модуля

Нижче описані помилки використання модуля, які призводять до критичного завершення роботи програми:

1. Не задано обробника переходу до початкового стану (`/`)
1. Спроба задати більше одного обробника для будь-якого стану
1. Перехід у стан, для якого не було задано обробника
1. Відсутність відповіді через Response (`send()` або `redirect()`) протягом заданого часу (Timeout)
1. Використання декількох відповідей через Response у одній вітці виконання коду
1. Задана у відповіді форма вводу (`InputForm`) не містить полів.